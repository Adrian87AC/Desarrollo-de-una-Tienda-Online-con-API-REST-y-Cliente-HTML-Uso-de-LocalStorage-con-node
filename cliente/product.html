<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">Tienda DWEC</a>
            <div class="d-flex">
                <a href="categories.html" class="btn btn-outline-info me-2">Categor칤as</a>
                <a href="cart.html" class="btn btn-outline-light me-2">游 Carrito (<span id="cartCount">0</span>)</a>
                <button class="btn btn-danger" onclick="logout()">Cerrar Sesi칩n</button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div id="productDetail" class="row">
            <div class="col-12 text-center">
                <p id="loadingMessage" class="text-muted">Cargando detalles del producto...</p>
                <div id="errorMessage" class="alert alert-danger d-none">Producto no encontrado o error de carga.</div>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Obtener la ID del producto de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                document.getElementById('loadingMessage').classList.add('d-none');
                document.getElementById('errorMessage').classList.remove('d-none');
                return;
            }

            // 2. Cargar los datos desde LocalStorage
            const { productos } = getTiendaData();
            const producto = productos.find(p => p.id === productId);
            const detailContainer = document.getElementById('productDetail');

            if (producto) {
                document.getElementById('loadingMessage').classList.add('d-none');
                
                // 3. Renderizar la ficha del producto
                detailContainer.innerHTML = `
                    <div class="col-md-6">
                        <img src="${producto.imagen}" alt="${producto.nombre}" class="img-fluid product-detail-img">
                    </div>
                    <div class="col-md-6">
                        <h2>${producto.nombre}</h2>
                        <span class="badge bg-secondary mb-3">${producto.id_categoria === 1 ? 'Electr칩nica' : 'Ropa'}</span>
                        <p class="lead">Un producto de alta calidad con excelentes caracter칤sticas...</p>
                        
                        <h3 class="text-success my-4">$${producto.precio.toFixed(2)}</h3>
                        
                        <button class="btn btn-primary btn-lg w-100" 
                                onclick="addToCart('${producto.id}', '${producto.nombre}', ${producto.precio}, '${producto.imagen}')">
                            A침adir al Carrito
                        </button>
                    </div>
                `;

                // 4. Almacenar el producto visto recientemente
                saveProductViewed(productId);
            } else {
                document.getElementById('loadingMessage').classList.add('d-none');
                document.getElementById('errorMessage').classList.remove('d-none');
            }
        });

        function saveProductViewed(productId) {
            let vistos = JSON.parse(localStorage.getItem('productos_vistos')) || [];
            
            // Eliminar duplicados para que el producto visto sea el m치s reciente
            vistos = vistos.filter(id => id !== productId);
            
            // A침adir el producto al principio de la lista
            vistos.unshift(productId);
            
            // Limitar la lista a, por ejemplo, los 칰ltimos 5 productos
            if (vistos.length > 5) {
                vistos.pop();
            }
            
            localStorage.setItem('productos_vistos', JSON.stringify(vistos));
            // Opcional: Notificar al servidor que se vio el producto
            // sendProductViewToServer(productId, localStorage.getItem('auth_token'));
        }
    </script>
</body>
</html>